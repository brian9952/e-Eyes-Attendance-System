import cv2
import os
import glob
import numpy as np
import random
import time
import shutil
import datetime
import subprocess
import json
import base64
import paho.mqtt.client as mqtt
import mysql.connector

sub_address = "/oneM2M/resp/antares-cse/c9ab16824dc3b3d4:c76af9ff466e3c4d/json"
db = mysql.connector.connect(
    host = "localhost",
    user = "brian",
    password = "1234",
    database = "scanner"
)

def insert_user_photo(name):
    print(db)
    arr_val = glob.glob("../images/dataset/*" + name + "*")
    
    db_cursor = db.cursor()
    sql = "INSERT INTO UserPhoto VALUES (NULL, %s, %s)"

    arr_sql = []
    for i in range(len(arr_val)):
        split_str = arr_val[i].split("/", 3)
        name_files = split_str[3]
        tup = (name_files, "images/dataset/")
        arr_sql.append(tup)

    db_cursor.executemany(sql, arr_sql)
    db.commit()

    last_id = db_cursor.lastrowid
    return last_id

def user_id_search(name):
    name_arr = name.split()
    db_cursor = db.cursor()

    sql = "SELECT UserId FROM UserData WHERE FirstName = '{}'".format(name_arr[0]);

    db_cursor.execute(sql)
    result = db_cursor.fetchone()

    user_id = result[0]

    return user_id

def insert_user_dataset(first_id, user_id):
    photoid_arr = []
    for i in range(first_id, first_id + 30):
        photoid_arr.append(i)

    now = datetime.datetime.now()
    datetime_now = now.strftime("%Y-%m-%d %H:%M:%S")

    insert_arr = []
    for i in range(len(photoid_arr)):
        user_tuple = (user_id, photoid_arr[i], datetime_now)
        insert_arr.append(user_tuple)

    db_cursor = db.cursor()

    sql = "INSERT INTO UserDataset VALUES (%s, %s, %s)"

    db_cursor.executemany(sql, insert_arr)
    db.commit()
    
def database_process(name):
    first_id = insert_user_photo(name)
    user_id = user_id_search(name)
    insert_user_dataset(first_id, user_id)

def dataTrain_processing(b64_str):
    base64_bytes = b64_str.encode("utf-8")
    base64_decode = base64.b64decode(base64_bytes)
    result = open("archive.zip", "wb")
    result.write(base64_decode)

    #child = subprocess.Popen(["mv", "archive.zip", "../images/dataset/"])
    #child.wait()
    #time.sleep(2)

    shutil.unpack_archive("./archive.zip", "../images/dataset/")
    child = subprocess.Popen(["rm", "./archive.zip"])
    child.wait()

def scan_image_processing(b64):
    base64_bytes = b64.encode("utf-8")
    base64_decode = base64.b64decode(base64_bytes)
    result = open("scan/scan_image.jpg", "wb")
    result.write(base64_decode)

def image_predict():
    process = subprocess.Popen(['python', 'predict.py'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    out, err = process.communicate("1")
    return out

def img_name_generator(size=10, chars=string.ascii_uppercase + string.digits):
   return ''.join(random.choice(chars) for _ in range(size))

def insert_scan_photo(userid)
    rand_string = img_name_generator()
    img_rename = "../images/data_scan/" + rand_string + ".jpg"
    process = subprocess.Popen(['mv', 'scan/photo.jpg', img_rename])

def get_data(name):
    name_arr = name.split()
    db_cursor = db.cursor()

    sql = "SELECT UserId, FirstName, LastName, Gender, Role FROM UserData WHERE FirstName = '{}'".format(name_arr[0])

    db_cursor.execute(sql)
    result = db_cursor.fetchone()

    userid = result[0]
    firstname = result[1]
    lastname = result[2]
    gender = result[3]
    role = result[4]

    return userid, firstname, lastname, gender, role

def insert_data_scan(userid, firstname, lastname, gender, role, temperature):
    now = datetime.datetime.now()
    datetime_now = now.strftime("%Y-%m-%d %H:%M:%S")
    db_cursor = db.cursor()

    sql = "INSERT INTO UserScan VALUES (%s, %s, %s, %s, %s, %s, %s)"
    val = (str(userid), firstname, lastname, gender, role, datetime_now, str(temperature))

    db_cursor.execute(sql, val)
    db.commit()

def update_data(userid, temperature):
    now = datetime.datetime.now()
    datetime_now = now.strftime("%Y-%m-%d %H:%M:%S")

    sql = "UPDATE UserData SET LastScan = {}, LastTemperature = {} WHERE UserId = {}".format(datetime_now, temperature, userid)


def database_process_scan(name, temperature):
    userid, firstname, lastname, gender, role = get_data(name)
    insert_data_scan(userid, firstname, lastname, gender, role, temperature)
    update_user_data(userid, temperature)
    insert_scan_photo(userid)

#def send_scan_results():


def process_message(message):
    mess_dict = json.loads(message)
    context = mess_dict["m2m:rsp"]["rqi"]
    content = mess_dict["m2m:rsp"]["pc"]["m2m:cin"]["con"]
    cnf = mess_dict["m2m:rsp"]["pc"]["m2m:cin"]["cnf"]

    return context, content, cnf

def on_connect(client, userdata, flags, rc):
    print("Server connected with result code {}".format(str(rc)))
    client.subscribe(sub_address)

def on_message(client, userdata, message):
    context, content, cnf = process_message(message.payload.decode("utf-8"))

    if context == "train_face":
        new_arr.append(content)
    elif context == "face_detect":
        scan_image_processing(cnf)
        name = image_predict()
        database_process_scan(name, content)


    print(len(new_arr))
    if len(new_arr) == 13:
        base64_raw = ''.join(new_arr)
        dataTrain_processing(base64_raw)
        database_process(cnf)
        child = subprocess.Popen(["python", "Train-Face.py"])
        child.wait()


broker = "mqtt.antares.id"
port = 1883
generate = random.randint(0, 100000)
client = mqtt.Client(str(generate))

global new_arr
new_arr = []
client.on_connect = on_connect
client.on_message = on_message

client.connect(broker, port)
client.loop_forever()
